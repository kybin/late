<!DOCTYPE html5>
<html>

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="css/default.css">
	<script type="text/javascript" src="script/jquery.js"></script>
</head>

<body>

<div id="title">{{.Title}}</div>
<div id="tab-selector">
	{{range .Chapters}}<div id="tab">Capter{{.Num}}</div>{{end}}
</div>
<div id="main">
	{{with index .Chapters 0}}
	{{range .Snippets}}
	<div class="blank">
	</div>
	<div class="snippet">
		<div class="snippet-top">
			<textarea class="orig">{{.Orig}}</textarea>
		</div>
		<div class="snippet-bottom">
			<textarea class="trans">{{.Trans}}</textarea>
		</div>
		<div class="snippet-bar">
			<button class="cancel button v-middle left red">Cancel</button>
			<button class="save button v-middle right blue">Save</button>
		</div>
	</div>
	{{end}}
	{{end}}
</div>

<!-- learn from http://webcomponents.org/articles/introduction-to-html-imports/ -->
<template id="snippet-new-template">
	<div class="blank">
	</div>
	<div class="new snippet">
		<div class="snippet-top">
			<textarea class="orig"></textarea>
		</div>
		<div class="snippet-bottom">
			<textarea class="trans"></textarea>
		</div>
		<div class="snippet-bar">
			<button class="cancel button v-middle left red">Cancel</button>
			<button class="save button v-middle right blue">Save</button>
		</div>
	</div>
</template>

<script type="text/javascript">
	function addNewSnippet() {
		var newSnippet = document.querySelector("#snippet-new-template");
		var newSnippetClone = document.importNode(newSnippet.content, true);
		$("#main").append(newSnippetClone);
	}
	// when document is loaded, there are only exist snippets.
	// we need a new snippet div in case of user want add one.
	addNewSnippet();

	$(".save").on({
		click:function() {
			$snippet = $(this).parents(".snippet");

			// because of the [blank, snippet, blank, snippet...] order,
			// index 1, 3, 5.. should mapped to 0, 1, 2..
			var idx = ($snippet.index() - 1) / 2;
			var type = "save";
			if ($snippet.hasClass("new")) {
				type = "new";
			}

			var path = $("#title").text() + "/" + "0" + "/" + idx;
			var orig = $(this).parent().parent().find(".orig").val();
			var trans = $(this).parent().parent().find(".trans").val();
			$.ajax({
				url: "/update",
				data: {
					type:type,
					content:"snippet",
					path:path,
					orig:orig,
					trans:trans,
				},
				success: function() {
					if (type == "new") {
						$snippet.removeClass("new");
					}
					// new snippet div should be added right after
					// the old one is disappeared.
					addNewSnippet();
					console.log("success");
				}
			});
		}
	});

	$("textarea").each(function() {
		var offset = this.offsetHeight - this.clientHeight;
		$(this).css('height', this.scrollHeight + offset);
	});

	$("textarea").bind("input propertychange", function() {
		$(this).parent().parent().find(".snippet-bar").css("display", "block");
		var offset = this.offsetHeight - this.clientHeight;
		// TODO: $(this).css('height', 'auto') couldn't shirink textarea nicely,
		// what's the alternatives? no plug-in.
		$(this).css('height', this.scrollHeight + offset);
	});

	$(".button").on({
		click:function() {
			$(this).parent(".snippet-bar").css("display", "none");
			$(this).parent().parent().find("textarea").each(function() {
				var offset = this.offsetHeight - this.clientHeight;
				$(this).css('height', 'auto').css('height', this.scrollHeight + offset);
			});
		}
	});
</script>

</body>

</html>
